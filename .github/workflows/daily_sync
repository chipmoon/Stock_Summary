name: Daily Portfolio Sync

on:
  schedule:
    # Runs at 12:00 UTC (20:00 Taiwan time) every day
    - cron: '0 12 * * *'
  workflow_dispatch:
    # Allows manual triggering from the GitHub UI

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create Google Sheets Key File
        run: |
          echo '${{ secrets.GOOGLE_SHEETS_JSON }}' > service_account.json

      - name: Run Trade Sync
        env:
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_FOLDER: ${{ secrets.EMAIL_FOLDER }}
          GOOGLE_SHEETS_KEY_FILE: service_account.json
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          WORKSHEET_NAME: ${{ secrets.WORKSHEET_NAME }}
          DRY_RUN: False
        run: |
          # Precise daily sync: scan only the last day for efficiency
          SINCE_DATE=$(date -d "1 day ago" +%d-%b-%Y)
          echo "Syncing trades since: $SINCE_DATE"
          python sync_history.py --since $SINCE_DATE
